<style>
    .bg-gray-light-2 { background-color: #f3f3f38c; }
</style>
<div class="container-fluid" >

    <div class="box-head-title-shop text-center" >
        <span class="header-shop"> การจัดส่ง</span>
    </div>

    <div class="main_data">
        
        
        <div class="row mb-4">
            <div class="col-12">
                
              <div class="shadow-sm rounded p-3">
                <div class="font-color-shop header-sub-title line-bottom-color-shop "> การจัดส่ง </div>
                    <div class="form-group row mt-2">
                        <div class="col-12  text-gray-light">
                            Delivery Type 
                            <select class=" editable_shop form-control-sm SHOP_delivery" data-field='delivery' >
                                <option disabled value='1'>LINE MAN </option>
                                <option disabled value='2'>Kinarai Delivery Service</option>
                                <option selected value='3'>จัดส่งเอง</option>
                                <option disabled value='4'>จัดส่งเอง เฉพาะพื้นที่ให้บริการ</option>
                            </select>
                        </div>
                    </div> 
                
                <!--/
                 <div class="font-color-shop header-sub-title line-bottom-color-shop"> ตารางกับหนดค่าจัดส่ง ต่อรอบการจัดส่ง </div>
                  / -->

            <div class="form-group row ">
                <div class="col-12 mb-3">
                   จำนวน สินค้า  <span><input class="input_data_bn editable_shop SHOP_max_deliver_item w-50 text-center" type='number' placeholder="เช่น 10" data-field="max_deliver_item"></span> ต่อ รอบ
                </div>

            </div> <!--//  -->
            </div> <!--//  -->
            </div> <!--//  -->
        </div> <!--//  -->
        
        
        

        <div class="font-color-shop header-sub-title line-bottom-color-shop shadow-sm  p-2 pl-3">
            กำหนดระยะทางการจัดส่งและค่าบริการ
        </div>

        <div id='delivery_type1' class="">
            <div class="row m-0 mb-4  row_tablecontent pt-3 shadow-sm rounded" data-id="##DELI-id##" >
                <div class="col mb-3">
                    <label class="col-sm-4 text-gray-light lable-left-35 ">
                        <b><span class="border-bottom-gray">กำหนดเงื่อนไขระยะทาง </span> <span class="text-danger">##DELI-distt1_order##</span></b>
                        <span class="float-right pr-2"><i class="fa fa-trash-alt text-danger fa-1x float-right" onclick="delete_delivery(this)"></i></span>
                    </label>
                    

                    <div class="col d-flex">
                        <div class="float-left w-100 ">
                            <div class="form-group row">
                                <div class="col-12 text-gray-light">
                                    ระยะไม่เกิน <span ><input class="input_data_bn editable_delivery_t1 w-50 text-center"  type='number' placeholder="ระยะทางไม่เกิน (Km)" data-field="distance" value="##DELI-distance##"></span> กิโลเมตร
                                    
                                </div>
<!--                                <div class="col-4">
                                    
                                </div>
                                <div class="col text-right text-gray-light">
                                    
                                </div>-->

                            </div> <!--//  -->
                            
                            

                            <div class="form-group row">
<!--                                <label class="col-5 text-gray-light"></label>-->
                                <div class="col-12 text-gray-light">
                                    ค่าบริการเริ่มต้น <span><input class="input_data_bn editable_delivery_t1 w-25 text-center" type='number' placeholder="เช่น 10" data-field="fee"  value="##DELI-fee##"></span> บาท
                                </div>
<!--                                <div class="col text-right text-gray-light">
                                    
                                </div>-->
                            </div> <!--//  -->
<!--
                            <div class="form-group row">
                                <span class="col-4 text-gray-light"> ค่าบริการต่อชิ้น</span>
                                <div class="col-4">
                                    <input class="input_data_bn editable_delivery_t1 " type='number' placeholder="เช่น 10" data-field="per_item"  value="##DELI-per_item##">
                                </div>
                                <span class="col-4 text-right text-gray-light">
                                    บาท
                                </span>
                            </div> //  -->
                            <div class="form-group row">
                                <div class="col-12 text-gray-light">
                                   ค่าบริการต่อ  1 Km <input class="input_data_bn editable_delivery_t1 text-center w-25" type='number' placeholder="เช่น 0.5" data-field="per_itemkm"  value="##DELI-per_itemkm##">  บาท
                                </div>
                            </div> <!--//  -->
<!--                            <div class="none_mar"></div>-->
                            <div class="text-danger mb-2 btn btn-sm  btn-light pl-1 pr-1" onclick="show_condition_t1(this)" val_ch="0"><i class="fas fa-cog"></i> ตั้งค่าขั้นสูง</div>
                            
                            <div class="p-2 rounded bg-gray-light-2"  style="display: none;">
                                <div class="mt-2 text-danger border-bottom-gray">เงื่อนไขพิเศษสำหรับการให้ส่วนลด <span class="float-right"><i class="fas fa-percent text-danger"></i> </span></div>
                                
                                <div class="form-group row mt-2">
                                    <div class="col-12 text-gray-light">
                                        ค่าบริการต่อชิ้น <span><input class="text-center input_data_bn w-50 editable_delivery_t1" type='number' placeholder="เช่น 10" data-field="per_item"  value="##DELI-per_item##"></span> บาท
                                    </div>

                                </div> <!-- // --> 
                                
                                <div class="form-group row mt-2">

                                    <div class="col-12 text-gray-light">
                                         เงื่อนไข <span>
                                        <select class=" editable_delivery_t1 condition_type w-40 form-control-sm" data-field="condition_type">
                                            <option value="0" selected="selected">ไม่กำหนดเงื่อนไข</option>
                                            <option value="1">ยอดสั่งซื้อที่เกิน..</option>
                                            <option value="2">ยอดสั่งซื้อที่ไม่เกิน..</option>
                                        </select>
                                        <input class="text-center input_data_bn editable_delivery_t1 w-25" type='number'   data-field="condition_amount"  value="##DELI-condition_amount##" >
                                         </span> บาท
                                    </div> 
                                </div> <!-- // --> 
                                
                                <div class="form-group row mt-2">

                                    <div class="col-12 ">
                                        จำนวนส่วนลด <span><input class="text-center input_data_bn editable_delivery_t1 w-50" type='number'   data-field="condition_discount"  value="##DELI-condition_discount##" ></span> บาท
                                       
                                    </div>

                                </div> <!-- // -->
                                
                                
                                
                                
<!--                                <div class="col-12">
                                    <span class="text-gray-light">เงื่อนไข </span>
                                    <select class=" editable_delivery_t1 condition_type" data-field="condition_type">
                                        <option value="0">ไม่กำหนดเงื่อนไข</option>
                                        <option value="1">ยอดสั่งซื้อที่เกิน..</option>
                                        <option value="2">ยอดสั่งซื้อที่ไม่เกิน..</option>
                                    </select>
                                    <input class="input_data_bn editable_delivery_t1 w-25" type='number'   data-field="condition_amount"  value="##DELI-condition_amount##" ><span class="text-gray-light">บาท</span>
                                </div>
                                <div class="col-12 text-gray-light ">
                                    <span>จำนวนส่วนลด <input class="input_data_bn editable_delivery_t1 w-25" type='number'   data-field="condition_discount"  value="##DELI-condition_discount##" ><span class="text-gray-light">บาท</span></span>
                                </div>-->
                            </div> <!--//  -->

                        </div>
                    </div>
                </div>


            </div> <!-- // Address -->
        </div>

    </div> <!--// main data  -->



    <div class="text-center mt-3 mb-3 pb-3 ">
        <button onclick='addnewdelivery(1);' class="btn btn-sm rounded-pill btn-submit-shop shadow-sm">
            <i class="fas fa-plus"></i> เพิ่ม ส่วนคำนวณ
        </button>
    </div> <!-- // btn -->


    <div class="row m-0 mt-3  pt-3  mb-5 shadow-sm rounded" id="delivery_type2">
        <label class="col-12 text-gray-light lable-left-35" >
            <b><span class="border-bottom-gray">ระยะเหมาจ่าย </span></b>
        </label>
        
        <div class="col d-flex  mb-3  row_tableconten " data-id="##DELI-id##">
            <div class="float-left w-100 ">
                <div class="form-group row">
                    <div class="col-12">
                        <span class="text-gray-light text-danger">ระยะเกินกว่า </span><span><input class="text-center input_data_bn editable_delivery_t2 w-50"  type='number' placeholder="ระยะทางไม่เกิน (Km)" value="##DELI-distance##" data-field="distance" data-id="##DELI-id##"></span> กิโลเมตร
                    </div>

                </div> <!--//  -->


                <div class="form-group row">

                    <div class="col-12 text-gray-light">
                        ค่าเริ่มต้น <span><input class="input_data_bn text-center editable_delivery_t2 w-25" type='number' placeholder="เช่น 10" data-field="fee"   value="##DELI-fee##" data-id="##DELI-id##"></span> บาท
                    </div>
                </div> <!--//  -->

<!--                <div class="form-group row">
                    <label class="col-4 text-gray-light">  ค่าบริการต่อชิ้น</label>
                    <div class="col-4">
                        <input class="input_data_bn editable_delivery_t2 " type='number' placeholder="เช่น 10" data-field="per_item"  value="##DELI-per_item##">
                    </div>
                    <div class="col-4 text-right text-gray-light">
                        บาท
                    </div>
                </div> -->
                <!--//  -->
                <div class="form-group row">
                    <div class="col-12 text-gray-light">
                        ค่าบริการต่อ  1 Km <span><input class="input_data_bn editable_delivery_t2 w-25 text-center" type='number' placeholder="เช่น 0.5" data-field="per_itemkm"  value="##DELI-per_itemkm##" data-id="##DELI-id##"></span> บาท
                    </div>
                </div> <!--//  -->
                
<!--                <div class="none_mar"></div>-->
                <div class="text-warning btn btn-sm btn-light" onclick="show_condition_t1(this)" val_ch="0"> 
                    <i class="fas fa-cog"></i> ตั้งค่าขั้นสูง
                </div>
                
                <div class="p-2 rounded bg-gray-light-2 mt-2" style="display: none;" >
                    
                    <div class="mt-2 text-warning border-bottom-gray">เงื่อนไขพิเศษสำหรับการให้ส่วนลด <span class="float-right"> <i class="fas fa-percent text-warning"></i>   </span></div>
                    <div class="form-group row mt-2">

                        <div class="col-12 text-gray-light">
                            ค่าบริการต่อชิ้น <span><input class="text-center input_data_bn editable_delivery_t2 w-50" type='number' placeholder="เช่น 10" data-field="per_item"  value="##DELI-per_item##" data-id="##DELI-id##"></span> บาท
                        </div>

                    </div> <!-- // -->   <!--//  -->
                    
                    
                     <div class="form-group row mt-2">
                        <div class="col-12  text-gray-light">
                             เงื่อนไข <span>
                                    <select class=" editable_delivery_t2 condition_type w-40 form-control-sm" data-field="condition_type" data-id="##DELI-id##">
                                        <option value="0" selected="selected">ไม่กำหนดเงื่อนไข</option>
                                        <option value="1">ยอดสั่งซื้อที่เกิน..</option>
                                        <option value="2">ยอดสั่งซื้อที่ไม่เกิน..</option>
                                    </select>
                                    <input class="text-center input_data_bn editable_delivery_t2 w-25" type='number'   data-field="condition_amount"  value="##DELI-condition_amount##"  data-id="##DELI-id##">
                                     </span> บาท
                        </div>
                        
                    </div> <!-- // --> 
                    
                    <div class="form-group row mt-2">

                        <div class="col-12 text-gray-light">
                            จำนวนส่วนลด <span><input class="text-center input_data_bn editable_delivery_t2 w-50" type='number'   data-field="condition_discount"  value="##DELI-condition_discount##"  data-id="##DELI-id##"></span> บาท

                        </div>

                    </div> <!-- // -->
          
              
                </div> <!--//  -->


            </div>

            <!--                            <div class="float-left pl-2 mb-2">
                                            <span class='SHOP_address editable_shop'>  </span>
                                        </div>-->
        </div>
    </div> <!-- // Address -->
</div>
<script>
    all_page = [''];
    var working = {};

    register_all_page();  // Register SubPAGE
//  #### Setting ########## For LINE APP
    var myLiffId = '1653987624-NPwXkOyo';   // <---- ต้องให้ตรงตามที่ตั้งค่าไว้กับทาง LINE ไม่งั้นมันจะ Redirect ไปไฟล์อื่น

//  #### END  Setting ########## For LINE APP


    var template_delivery_type1 = $('#delivery_type1').html();
    var template_delivery_type2 = $('#delivery_type2').html();

    $('#delivery_type1').html('');
//    $('#mytable .row_tablecontent').attr('id', "displaynone1")
    //  $('#displaynone1').hide()
    var maintable = $('#mytable');

    function runApp() {
        console.log("RUN APP");
        $.postJSON('/api/liff/check/shopowner', {LINE_USER: LINE_USER}, function (res) {
            console.log(res);
            if (res.result) {
                working.shop = res.detail;
                setdatabyclass($('.main_data'), 'SHOP', working.shop);
//                go2View('salepackage1');
            } else {

//                go2View('must-openshop');
            }
            get_delivery()
        });

    }


    function show_condition_t1(obj) {
        var tempid = $(obj).find_id();
        if ($(obj).attr('val_ch') == 0) {
            $(obj).next().show('slow')
            $(obj).attr('val_ch', 1)
        } else if ($(obj).attr('val_ch') == 1) {
            $(obj).next().hide('slow')
            $(obj).attr('val_ch', 0)
        }
    }
    var number_list=0

    function get_delivery() {
//        console.log('get data type 1')
        $.postJSON('/api/liff/check/shopdalivery', {LINE_USER: LINE_USER}, function (res2) {
            //alert(JSON.stringify(res2.detail));
            if (res2.result) {
                //$('#delivery_type1').html(JSON.stringify(res2.detail));                return;
                if (Array.isArray(res2.detail) && res2.detail.length > 0) {    // มีร้านอยู่แล้ว
                    var type1 = [];
                    var type2 = {};
                    var count = 0;
                    number_list=0
                    for (var x = 0; x < res2.detail.length; x++) {
                        if (res2.detail[x].type == 1) {
                            number_list = number_list+1
                            res2.detail[x].distt1_order = number_list
                            if(!res2.detail[x].condition_type){
                                res2.detail[x].condition_type =0
                            }
                            
                            type1.push(res2.detail[x]);
                        } else if (res2.detail[x].type == 2) {
                            if(!res2.detail[x].condition_type){
                                res2.detail[x].condition_type =0
                            }
                            type2 = res2.detail[x];
                        }
                    }

                    $('#delivery_type1').html(hash_replace(template_delivery_type1, 'DELI', type1));
                    $('#delivery_type2').html(hash_replace(template_delivery_type2, 'DELI', type2));
                    $('.condition_type').each((i, el) => {     // ปรับค่า selected ของ Option หลัง hash_replace
                        var temp = res2.detail[i].condition_type || 0;  // default 0
                        var id = $(el).find_id();
                        res2.detail.map((obj) => {
                            if (obj._id == id)
                                $(el).val(obj.condition_type);
                        });

                    });
                    console.log('true')
                    set_obj_fusefiled($('.editable_delivery_t1'), 1);
                    set_obj_fusefiled($('.editable_delivery_t2'), 2);

                } else {
                    addnewdelivery(1);
                    addnewdelivery(2);
                }
                //                go2View('salepackage1');
            } else {

                // New <data value="

            }
        });
    }

    $('.editable_shop').Fusefield((obj, cb, data) => {
        console.log(data)
        data._id = working.shop._id
        $.postJSON('/api/liff/edit/shop', data, function (res) {
            if (!res.result) {
                alert(res.detail);
                cb(false);
            } else
                cb(true);
        })
    }, (obj) => {
        if (obj.attr('data-field') == "max_deliver_item") {
            if (Number(obj.val()) < 1) {
                alert("Max Items ต้องมากกว่า 0");
                return false;
            }
        }
        return true;
    });

    function set_obj_fusefiled(jqueryobj, type) {
        jqueryobj.Fusefield((obj, cb, data) => {
            data.type = type;
            
            console.log(data)
            if(obj.find_id()==false&&obj.attr('data-id')!==false){
                data._id= obj.attr('data-id')
            }else{
                data._id = obj.find_id();
            }
            
            //alert("SETID " + data._id);
            $.postJSON('/api/liff/edit/deliverytable', data, function (res) {
                console.log(res)
                if (!res.result) {
                    alert(res.detail);
                    cb(false);
                } else {
                    cb(true);
                    if (type == 2 && !data._id) {
                        // Update ID
                        $('#delivery_type2').html(hash_replace(template_delivery_type2, 'DELI', res.detail));
                        set_obj_fusefiled($('.editable_delivery_t2'), 2);
                    } else if (type == 1) {
                        // Find Max Of type1 find("[data-field=distance]").
//                        var maxfound = 0;
//                        $('.editable_delivery_t1[data-field=distance]').each((index, dmax) => {
//                            console.log(index)
//                            console.log(maxfound + "': " + $(dmax).val())
//                            if (maxfound < $(dmax).val())
//                                maxfound = $(dmax).val();
//                        });
//                        if (Number(maxfound) != Number($('#last_distance').val())) { // Update Lastest Distance
//                            var data2 = {LINE_USER: LINE_USER, type: 2, distance: maxfound}
//                            $('#last_distance').val(maxfound);
//                            data2._id = $('#last_distance').find_id();
//                            $.postJSON('/api/liff/edit/deliverytable', data2, function (res) {
//                                if (!res.result) {
//                                    alert(res.detail);
//                                }
//                            });
//                        }

                    }

                }
                //            get_deliver_type1()
            })
        }, (obj) => {
            if (obj.attr('data-field') == 'distance') {
                if (Number(obj.val()) > 0)
                    return true;
                else {
                    alert("ค่าทำกำหนดต้องมากกว่า 0");
                    return false;
                }
            } else {
                if (Number(obj.val()) >= 0)
                    return true;
                else {
                    alert("ค่าทำกำหนดต้องไม่น้อยกว่า 0");
                    return false;
                }
            }
            return true;
        });
    }

    function delete_delivery(obj) {

        var tempid = $(obj).find_id();
        var data3 = {LINE_USER: LINE_USER, _id: tempid}
        console.log(data3)
        if (confirm('คุณต้องการลบเงื่อนไขนี้ใช่หรือไม่') == true) {
            $.postJSON('/api/liff/delete/deliverytable', data3, function (res) {
                console.log(res)
                if (!res.result) {
                    alert(res.detail);
                } else {
                    alert('ลบข้อมูลเรียบร้อยแล้ว')
                    number_list = number_list-1
                    get_delivery()
                }
            });

        }
        
    }

    function addnewdelivery(type) {
//

        $.postJSON('/api/liff/edit/deliverytable', {LINE_USER: LINE_USER, type: type}, function (res) { // Create New Data
            if (res.result) {
                var obj = res.detail;

                if (type == 2) {
                    var html = hash_replace(template_delivery_type2, 'DELI', obj)
                    $('#delivery_type2').html(html);
                    set_obj_fusefiled($('.editable_delivery_t2'), 2);
                } else {
                    number_list = number_list+1
                    obj.distt1_order = number_list
                    var html = hash_replace(template_delivery_type1, 'DELI', obj)
                    $('#delivery_type1').append(html);
                    set_obj_fusefiled($('.editable_delivery_t1'), 1);
                }

            }
        });

    }
    initializeLiff();

//  $('#body_mainbody').load('/LIFF/preload.html');
</script>
