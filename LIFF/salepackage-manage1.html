
<div class='container-fluid main_data' >
  <div class="row box-head-title-shop">
      <div class="col-3 p-0 text-left">
          <button class='btn border border-0 text-secondary' onclick="window.history.back();">
              <i class="fas fa-chevron-left"></i> Back
          </button>
      </div>
      <div class="col-6  text-center" >
        <h5>ชื่อเมนู : <span class='MENU_name font-color-shop' ></span></h5>
        <span class="text-gray-light2">รหัสเมนู #<span class="MENU_id">MENU ID</span></span>

      </div>
      <div class="col-3 p-0 text-left">

      </div>

  </div>
<!--
    <div class="box-head-title-shop text-center" >
        <span class="header-shop"> จัดการเมนูอาหาร</span>
    </div> -->




    <div class="form-group row mt-3 border-bottom border-light">
        <label class="col-sm-4 text-gray-light " style="width:auto;">  กำหนดเมนู <span class="text-gray-light2">(ปิด - เปิด)</span> </label>
        <div class="col text-right d-flex d-inline ">
            <div class="ml-auto">
                <label class="switch">
                    <input type="checkbox" id="menu_status" onchange="changemenustatus(this)">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
        <div class="col-sm-12">
            <small class="text-warning mt-1 warn_status" style="display:none;"></small>
        </div>
    </div> <!-- // กำหนดเมนู (เปิด-ปิด) -->


    <div class="form-group row mt-3 border-bottom border-light">
        <label class="col-sm-4 text-gray-light " style="width:auto;">  การยืนยัน Order <span class="text-gray-light2">(Manual - Auto)</span> </label>
        <div class="col text-right d-flex d-inline ">
            <div class="ml-auto">
                <label class="switch">
                    <input type="checkbox" id="confirm_order" onchange="changeconfirm_order(this)">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
        <div class="col-sm-12">
            <small class="text-warning mt-1 warn_status" style="display:none;"></small>
        </div>
    </div> <!-- // การยืนยัน order auto-mannual -->


    <div class="form-group row mt-3">
            <label class="col-6 text-gray-light lable-left-35 " > จำกัดต่อวัน </label>
            <div class="col">
                <input id="limit_date" class="input_data_bn edit_data MENU_limit_date w-90 " placeholder="จำกัดต่อวัน" data-field="limit_date">
            </div>
    </div>

    <div class="form-group row mt-3">
        <label class="col-6 text-gray-light lable-left-35 " > ตัวเลือกเสริม เลือกได้ </label>
        <div class="col">
            <input  class="input_data_bn edit_data MENU_optionlimit w-100" data-field="optionlimit" >

        </div>
        <div class="col">
            รายการ
        </div>
    </div>

    <div class="form-group row mt-3">
        <label class="col-6 text-gray-light lable-left-35 " > รายการ </label>
        <div class="col-12">
          <select class="MENU_option button-top_gray w-100 p-2 "  multiple="multiple" placeholder="ตัวเลือกเสริม">
          </select>
          <small id="emailHelp" class="form-text text-muted"> *ตัวเลือกเสริม (ที่ไม่เกี่ยวกับราคา) </small>
        </div>
    </div>



<!--    <div class="form-group row mt-3 border-bottom border-light">
          <label class="col-sm-12 text-gray-light lable-left-35 " ><b> ตัวเลือกเสริม เลือกได้  </b>
              <input  class="input_data_bn edit_data MENU_optionlimit w-10" data-field="optionlimit" > รายการ</label>

          <div class="col d-flex">

              <div class="float-left pl-2 mb-2 w-100 ">
                <select class="MENU_option button-top_gray col-12 col-sm-12 p-2 "  multiple="multiple" placeholder="ตัวเลือกเสริม">
                </select>
                <small id="emailHelp" class="form-text text-muted"> *ตัวเลือกเสริม (ที่ไม่เกี่ยวกับราคา) </small>
              </div>
          </div>
    </div> -->


    <div class="form-group row mt-3 border-bottom border-light mt-3">
        <label class="col-sm-4 text-gray-light " style="width:auto;">  กำหนดราคา </label>
        <div class="col text-right d-flex d-inline">
            <div class="ml-auto">
                <button type="button" name="button" style="border-radius: 20px;" class="btn btn-sm btn-submit-shop addnewmenuprice" onclick='show_moremanagemenuprice();'>
                    <i class="fas fa-plus"></i> เพิ่มราคาเมนู
                </button>
            </div>
        </div>
    </div> <!-- // กำหนดราคา -->

    <small id="menupricelist">
        <div class="mt-1 row_tablecontent" style="display:none;">

            <div class="form-group row mt-3 border border-bottom border-light">
                <div class="col-6 d-inline pt-2" style="width: auto;">
                    <span class="menuprice_detail text-title110" style="width:auto;"> </span>
                    <div>
                        ราคา <span class="menuprice_price font-color-shop"></span> <span class="text-gray-light">บาท</span>
                    </div>
                    <div style="display:none;" class="shownormalprice">
                        ราคาก่อนจัดโปรโมชั่น <span class="menuprice_normal_price font-color-shop"></span> <span class="text-gray-light">บาท</span>
                    </div>
                </div>
                <div class="col-3  p-2">
                      <span class="btn btn-sm btn-light text-secondary" onclick="showeditprice(this);">ตั้งค่า<i class="fas fa-cog"></i></span>
                </div>
                <div class="col text-right d-flex d-inline pt-2">
                    <div class="ml-auto">
                        <label class="switch">
                            <input type="checkbox" class="menuprice_status" onchange="managepricestatus(this);">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
            </div> <!-- // จำกัดต่อวัน -->

        </div> <!--// row_tablecontent -->
    </small>
    <!-- </div> // card-body -->
</div>

<div class="modal fade" id="modal_edit_price"  tabindex="-1" role="dialog"  aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
        <div class="modal-body" id="frmeditprice" >
          <div class="row">
              <div class="col-6 text-left">
                  <h5>จัดการข้อมูลราคา</h5>
              </div>
              <div class="col-6 text-right">
                  <span class="btn btn-outline-danger btn-sm" onclick="editprice($('#editprice').val(),$('#editpricedetail').val(),'delete');">ลบรายการ</span>
              </div>
          </div>
          <div class="row mt-1">
              <div class="col-4">
                  คำอธิบายเมนู
              </div>
              <div class="col">
                  <textarea type="text" id="editpricedetail" class="form-control"></textarea>
              </div>
          </div>
          <div class="row mt-1">
              <div class="col-4">
                  กำหนดราคา
              </div>
              <div class="col">
                  <div class="input-group">
                      <input type="number" id="editprice" class="form-control">

                  </div>
              </div>
          </div>
          <div class="row mt-1" id="frmeditnormal_price" style="display:none;">
              <div class="col-4">
                  ราคาก่อนจัดโปรโมชั่น
              </div>
              <div class="col">
                  <div class="input-group">
                      <input type="number" id="editnormal_price" class="form-control">

                  </div>
              </div>
          </div>
          <button class="btn btn-sm btn-submit-shop btn-block mt-3" onclick="editprice($('#editprice').val(),$('#editpricedetail').val(),'save');">บันทึก</button>
          <hr>
        </div>

    </div>
  </div>
</div>


<div class="modal fade" id="modal_add_newprice"  tabindex="-1" role="dialog"  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">เพิ่มราคาเมนู</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group mt-1">
            <div class='show_managemenuprice mt-2 w-100' id="form_addnewprice">
                <div class="row mt-1">
                    <div class="col-4">
                        <span class="head_newprice_detail">คำอธิบาย</span>

                    </div>
                    <div class="col">
                        <textarea type="text" id="newprice_detail" class="form-control"></textarea>
                        <small class="text-secondary text-gray-light2 warn_newprice_detail">(เช่น ราคาปกติ/เพิ่มใข่ดาว)</small>
                    </div>
                </div>
                <div class="row mt-1">
                    <div class="col-4">
                        <span class="head_newprice">ราคา</span>
                    </div>
                    <div class="col">
                        <div class="input-group">
                            <input type="number" id="newprice_price" class="form-control">
                            <div class="input-group-prepend">
                                <div class="input-group-text">บาท</div>
                            </div>
                        </div>
                        <small class="text-secondary text-gray-light2 warn_newprice">ราคาขายปกติ</small>
                    </div>
                </div>
                <div class="form-group border-bottom border-light bg-secondary row">
                  <div class="col-12">
                    <div class="row">
                      <label class="col-sm-4 text-gray-light font-color-shop mt-2" style="width:auto;">จัดราคาโปรโมชั่น <span class="text-gray-light2">(ปิด - เปิด)</span> </label>
                      <div class="col text-right d-flex d-inline ">
                          <div class="ml-auto mt-2">
                              <label class="switch">
                                  <input type="checkbox" id="menu_promote" onchange="showadd_promotion(this)">
                                  <span class="slider round"></span>
                              </label>
                          </div>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-sm-12">
                          <small class="text-warning mt-1 warn_status" style="display:none;"></small>
                      </div>
                    </div>
                      <div class="form-group mt-3" id="show_promotion" style="display:none;" >
                        <div class="row mt-1">
                            <div class="col-4">
                                ราคาโปรโมชั่น
                            </div>
                            <div class="col">
                                <div class="input-group">
                                    <input type="number" id="promotion_price"disabled class="form-control">
                                    <div class="input-group-prepend">
                                        <div class="input-group-text">บาท</div>
                                    </div>
                                </div>
                                <small class="text-secondary text-light">(ราคาที่จัดโปรโมชั่น)</small>
                            </div>
                        </div>
                  </div>
                    </div>


                </div> <!-- // กำหนดเมนู (เปิด-ปิด) -->
                <small class="text-danger">**กรุณาเพิ่มข้อมูลราคา และรายละเอียดราคาให้ครบถ้วน</small>
                <button class="btn btn-sm btn-submit-shop btn-block mt-3" onclick="addnewprice(this);">+ เพิ่มรายการ</button>
                <hr>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>



<script type="text/javascript">
    refresh_managemenupage();

    //for input tag
    $('.edit_data').Fusefield( (obj,cb)=>{
      var field = obj.attr('data-field');
      var data = {}; data._id = working.activemenu._id;
      data.LINE_USER = LINE_USER;
      data[field] = obj.val();

      // console.log("data",data);
      update_menu(data,cb)
    },(obj)=>{
      return true;
    });

    function refresh_managemenupage() {
        $.postJSON('/api/liff/get/menu', {LINE_USER: LINE_USER, _id: working.menunow}, (res) => {
            if (!res.result) {
                alert(res.detail);
                return;
            }

            working.activemenu = res.detail;
            // Set Default
            if (!working.activemenu.status)
                working.activemenu.status = 4;
            if (!working.activemenu.limit_date)
                working.activemenu.limit_date = '';
            if (!working.activemenu.price || Array.isArray(working.activemenu.price) == false)
                working.activemenu.price = [];


            if (working.activemenu.price.length > 0) {
                showmenuprice(working.activemenu.price);
            }
            if (working.activemenu.confirm_order == "auto") {
                $('#confirm_order').prop('checked', true);
            } else if (working.activemenu.confirm_order == "manual") {
                $('#confirm_order').prop('checked', false)
            }
            if (working.activemenu.status == 5) {
                $('#menu_status').prop('checked', true);
            } else {
                $('#menu_status').prop('checked', false)
            }
            if (working.activemenu.status < 4) {
                $('.warn_status').html('หากเมนูนี้ยังไม่ผ่านการตรวจสอบจะไม่สามารถเปิดใช้ได้').show();
                $('#menu_status').prop('disabled', true)
            } else {
                $('.warn_status').hide();
            }


            setdatabyclass($('.main_data'), 'MENU', working.activemenu);
            create_menuoption();

        });
    };


    function addnewprice() {

      if (!Array.isArray(working.activemenu.price)) {
          working.activemenu.price = [];
      }
        var detailprice = $('#newprice_detail').val();
        var newprice = $('#newprice_price').val();
        var promotion_price = $('#promotion_price').val();
        var pricearr = working.activemenu.price;

        if (!detailprice) {
            alert('กรุณาในข้อมูลคำอธิบายราคา');
            return false;
        }
        if (!newprice) {
            alert('กรุณากำหนดราคา');
            return false;
        }
        for (var x = 0; x < pricearr.length; x++) {
            if (pricearr[x].active == true && pricearr[x].price == newprice && pricearr[x].detail == detailprice) {
                alert('คุณมีข้อมูลนี้แล้ว');
                return false;
            }
        }

        if (promotion_price) {
            working.activemenu.price.push({detail: detailprice, price:promotion_price ,normal_price : newprice, status: 1});
        }else {
          working.activemenu.price.push({detail: detailprice, price: newprice, status: 1});
        }

        var data = {LINE_USER: LINE_USER, _id: working.menunow, price: working.activemenu.price};

        // console.log(data);
        update_menu(data);
        $('#modal_add_newprice').modal('hide');
        // $('.show_managemenuprice').hide();
        $('#newprice_detail').val('');
        $('#newprice_price').val('');
    };



    function changeconfirm_order(obj_con) {
        var dataid = working.activemenu._id;
        var confirm_order;
        if ($(obj_con).is(':checked')) {
            confirm_order = "auto";
        } else {
            confirm_order = "mannual";
        }
        var data = {LINE_USER: LINE_USER, _id: dataid, confirm_order: confirm_order};
        // console.log("sending", data)
        update_menu(data);
    }
    function changemenustatus(obj) {
        if (!working.activemenu.price || working.activemenu.price.length <= 0) {
            $('.warn_status').html('กรุณาเพิ่มราคาเมนูก่อน จะทำการเปิดขายได้').show();

            setTimeout(function () {
                $('.warn_status').hide('slow');
                $('.warn_status').html('')
            }, 3000);
            $(obj).prop('checked', false)
            return false;
        }
        var dataid = working.activemenu._id;
        var menu_status;
        if ($(obj).is(':checked')) {
            menu_status = 5;
        } else {
            menu_status = 4;
        }
        var data = {LINE_USER: LINE_USER, _id: dataid, status: menu_status};
        console.log("sending", data)
        update_menu(data);
    };

    var template_menuprice = $('#menupricelist').html();
    function showmenuprice(obj) {
        $('#menupricelist').html(template_menuprice);
        for (var x = 0; x < obj.length; x++) {
            // if(!obj[x].status) obj[x].status = 1;
            var TR = tablerow($("#menupricelist"), 'menuprice', obj[x], template_menuprice, false);
            if (obj[x].status == 1) {
                TR.find('.menuprice_status').prop('checked', true);
            } else {
                TR.find('.menuprice_status').prop('checked', false);
            }
            if (obj[x].normal_price) {
                TR.find('.shownormalprice').show();
            } else {
                  TR.find('.shownormalprice').hide();
            }
            TR.attr('value', obj[x].detail);
            TR.attr('value-price', obj[x].price);
            TR.show();
        }
    }


    // var moremanagemenuprice = false;
    function show_moremanagemenuprice() {

      $('#modal_add_newprice').modal('show');
        // if (moremanagemenuprice) {
        //     $('.show_managemenuprice').hide();
        // } else {
        //     $('.show_managemenuprice').show();
        // }
        // moremanagemenuprice = !moremanagemenuprice;
    }

    function managepricestatus(obj) {
        // var price = parseFloat(Number($(obj).parents('.row_tablecontent .menuprice_price')));
        var price = $(obj).parents('.row_tablecontent').attr('value-price');
        var value = $(obj).parents('.row_tablecontent').attr('value');
        var newstatus;
        if ($(obj).is(':checked')) {
            newstatus = 1;
        } else {
            newstatus = 0;
        }
        // alert(newstatus);
        for (var x = 0; x < working.activemenu.price.length; x++) {
            if (working.activemenu.price[x].price == price && working.activemenu.price[x].detail == value) {
                working.activemenu.price[x].status = newstatus;
            }
        }
        // console.log('peice ', working.activemenu.price);
        var data = {LINE_USER: LINE_USER, _id: working.menunow, price: working.activemenu.price};
        console.log(data);
        update_menu(data);
    };


  function update_menu(data,cb){

    $.postJSON('/api/liff/edit/menu', data, (res) => {
        if (!res.result) {
            if(cb) cb(false);
            return alert(res.detail);
        } else {
            if(cb) cb(true);
            refresh_managemenupage();
        }

    });
  }

  var editmemuprice ={};
   function showeditprice(obj){
     var found;
     var price = $(obj).parents('.row_tablecontent').attr('value-price');
     var value = $(obj).parents('.row_tablecontent').attr('value');
     for (var x = 0; x < working.activemenu.price.length; x++) {
         if (working.activemenu.price[x].price == price && working.activemenu.price[x].detail == value) {
              editmemuprice = working.activemenu.price[x];
              found = true;
         }
     }
     if(found){
       // $('.jsonshow').html(JSON.stringify(editmemuprice));
       if (editmemuprice.normal_price) {
          $('#frmeditnormal_price').show();
           $('#editnormal_price').val(editmemuprice.normal_price).prop('disabled',false);
       }else {
         $('#frmeditnormal_price').hide();
          $('#editnormal_price').val('').prop('disabled',true);
       }
       $('#editprice').val(editmemuprice.price);
       $('#editpricedetail').val(editmemuprice.detail)
       $('#modal_edit_price').modal('show');
     }
   };

   var temp_frmeditprice = $('#frmeditprice').html();

   function editprice(price,value,action){
     var normalprice = $('#editnormal_price').val();
     for (var x = 0; x < working.activemenu.price.length; x++) {
           if (working.activemenu.price[x].price == Number(editmemuprice.price) && working.activemenu.price[x].detail == editmemuprice.detail) {
                if (action == 'save') {
                  working.activemenu.price[x].price = Number(price);
                  working.activemenu.price[x].detail = value;
                }else if (action == 'delete') {
                    working.activemenu.price.splice(x, 1);
                }
           }
     };
     var data = {LINE_USER: LINE_USER, _id: working.menunow, price: working.activemenu.price};
     if (normalprice) {
          data.normal_price = normalprice;
     }
     update_menu(data);
     $('#frmeditprice').html(temp_frmeditprice);
      $('#modal_edit_price').modal('hide');
   };


var temp_form_addnewprice = $('#form_addnewprice').html();
   function showadd_promotion(obj) {
     $('#promotion_price').val('');
       if ($(obj).is(':checked')) {
         $('.head_newprice_detail').html('คำอธิบาย<br>โปรโมชั่น');
         $('.head_newprice').html('ราคาปกติ');
         $('.warn_newprice').html('(ราคาปกติก่อนจัดโปรโมชั่น)');
         $('.warn_newprice_detail').html('(คำอธิบายหรือคำโฆษณา)');
         $('#promotion_price').prop('disabled',false);
         $('#show_promotion').show();
       } else {
         $('#form_addnewprice').html(temp_form_addnewprice);
          $('#promotion_price').prop('disabled',true);
         $('#show_promotion').hide();
       }
   };

   function create_menuoption(){
     var seldata = `<option disabled> เช่น เผ็ด, เผ็ดมาก , สุกปานกลาง เป็นต้น</option>`;
      if(Array.isArray(working.activemenu.option)){
        for (var x = 0; x < working.activemenu.option.length; x++) {
            seldata += '<option value="' +working.activemenu.option[x] + '" selected >' + working.activemenu.option[x] + '</option>';
        }
      }
      $('.MENU_option').off('change.select2');
      $('.MENU_option').html(seldata);


     $('.MENU_option').select2({
         tags: true,
         tokenSeparators: [',', ' '],
         allowClear: true,
         createTag: function (params) {
             if (params.term === '') {
                 return null;
             }
             //if (allownewtag) {
                 return {id: params.term, text: params.term};
             //}
             //return null;

         }
     });
     $('.MENU_option').on('change.select2', function (e) {
       var data = {LINE_USER: LINE_USER, _id: working.menunow, option: $('.MENU_option').val()};
       // console.log(data);
       $.postJSON('/api/liff/edit/menu', data, (res) => {
           if (!res.result) {
               return alert(res.detail);
           }
       });
     });
    }
</script>
