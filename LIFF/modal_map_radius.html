<!-- Modal for GPS -->
<style media="screen">
  #googlemap {
      position: relative;
  }
</style>
<div class="modal fade " id="modal_google_gps" tabindex="-1" role="dialog"  aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">ตำแหน่งที่ตั้งสาขา</h5> <!-- Image Preview -->
        </div>

        <div class="modal-body" style="width:500; height:500">

          <div    id='googlemap' style="width: 100%; height: 300px" >
    			Gmaps

          </div>

        </div>
        <div id="floating-panel">
          รัศมี
          <input id="input-radius" style="width: 20%" type="number" min="0" value="">
          <!-- <input id="submit" type="button" value="Reverse Geocode"> -->
          เมตร
        </div>

        <div class="modal-footer">
            <!-- <button onclick="btn_modal_map_current()" class="btn btn-sm btn-danger"><i class="fas fa-map-marker-alt"></i> ใช้ที่อยู่ปัจจุบัน</button> -->
            <button onclick="btn_modal_map()" class="btn btn-sm btn-orange"><i class="fa fa-fw fa-save"></i> บันทึกขอบเขตบริการ </button>
            <button onclick="$('#modal_google_gps').modal('hide');" class="btn btn-sm btn-light border border-secondary"><i class="fa fa-fw fa-times"></i> Close </button>
        </div>

    </div>
  </div>
</div>

<script>

  var tempcbfnc_maps;
  var gmap;
  var themarker;
  var themarker_image;
  var delay_marker;
  var geocoder;
  var infowindow;
  var latlng;
  var latlng_marker;
  var address;
  var latlng_saved;
  var latlng_default_startup;
  var alreadyset = false;
  var circle_area;
  var service_radius = 0;
  
  function initMap() {
    console.log("init Map");
    // Initialize Map
    gmap = new google.maps.Map(document.getElementById('googlemap'), {
      center: latlng_saved,
      zoom: 15,
      disableDefaultUI: true,
      gestureHandling: 'greedy'
    });

    geocoder = new google.maps.Geocoder;
    infowindow = new google.maps.InfoWindow;

    // Event Map Click
    // google.maps.event.addListener(gmap, 'click', function(event) {
    //   gmap.setZoom(18);
    //   gmap.panTo(event.latLng);
    // });

    // Draw Circle Area
    circle_area = new google.maps.Circle({
      strokeColor: '#FF0000',
      strokeOpacity: 0.8,
      strokeWeight: 2,
      fillColor: '#FF0000',
      fillOpacity: 0.35,
      map: gmap,
      center: gmap.getCenter(),
      radius: service_radius
    });

    const input = document.querySelector('input');
    const input_radius = document.getElementById('input-radius');
    input.oninput = inputRadiusHandler;

    function inputRadiusHandler(e) { 
      service_radius = parseInt(e.target.value)
      document.getElementById('input-radius').value = service_radius === 0 ? "":service_radius.toString();
      circle_area.setRadius(service_radius);
    }

    // Event Map Screen Move
    // gmap.addListener('center_changed', showAddress);
  }

  function showAddress() {
    // Start Count Timer Again Before Time Runs Out
    clearTimeout(delay_marker);
    infowindow.close();
    // circle_area.setVisible(false);

    if(alreadyset){
      setTimeout(()=>{
        alreadyset = false;
      }, 150);
      gmap.panTo(latlng_marker);
      infowindow.setPosition(latlng_marker);
      infowindow.setContent(address);
      infowindow.open(gmap);
      return;
    }

    delay_marker = window.setTimeout(function() {
      // circle_area.setVisible(true);
      // circle_area.setCenter(gmap.getCenter());

      // Show Address via Latitude Longtitude Location
      latlng = gmap.getCenter();
      geocoder.geocode({'location': latlng}, function(results, status) {
        if (status === 'OK') {
          if (results[0]) {
            alreadyset = true;
            address = results[0].formatted_address;
            latlng_marker = latlng;
            infowindow.setPosition(latlng);
            infowindow.setContent(address);
            infowindow.open(gmap);
            // document.getElementById('address').value = address;
            setTimeout(()=>{
              alreadyset = false;
            }, 150);
          } else {
            window.alert('No results found');
          }
        } else {
          window.alert('Geocoder failed due to: ' + status);
        }
      });

    }, 1000);
  }

  function btn_modal_map_current(){
      googlemap_geogetLocation();
  }
  function googlemap_geogetLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position){
        var pos = {lat:position.coords.latitude,lng: position.coords.longitude};
        gmap.setZoom(18);
        gmap.panTo(pos);
      } ,show_modal_mapError);
    } else {
      alert("Geolocation is not supported by this browser.");
    }
  }
  function show_modal_mapError(error) {
    console.log(error);
    alert("error No GPS Allowed")
  }

  function call_modal_maps(setting,cbfnc) {
    var latlng_have_save;
    latlng_default_startup = {lat:13.796135897043685, lng:100.71161980133971};  // ADVWS;
    
    if ( ('lat' in setting) && ('lng' in setting) ) {
      latlng_have_save = true;
      latlng_saved = {};
      latlng_saved.lat = setting.lng;    // switch bewteen LAT to LNG from MongoDB    
      latlng_saved.lng = setting.lat;    // switch bewteen LAT to LNG from MongoDB

      if ('service_radius' in setting) {
        service_radius = setting.service_radius;
      } else {
        service_radius = 0;
      }
    } else {
      latlng_have_save = false;
      latlng_saved = latlng_default_startup;
      service_radius = 0;
    }
    // window.alert(JSON.stringify(latlng_saved));

    // $('#modal_google_gps').modal('show');
    setTimeout(()=>{
      initMap();
      $('#modal_google_gps').modal('show');
      if(typeof(setting) == 'function'){
        cbfnc = setting;
        // setting ={lat:13.79607108667891,lng:100.71164142340422};
      }else{
      }

      tempcbfnc_maps = cbfnc;

      if (latlng_have_save === true) {
        themarker_image = {
          url: 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png',
          // This marker is 20 pixels wide by 32 pixels high.
          size: new google.maps.Size(20, 32),
          // The origin for this image is (0, 0).
          origin: new google.maps.Point(0, 0),
          // The anchor for this image is the base of the flagpole at (0, 32).
          anchor: new google.maps.Point(0, 32)
        };

        themarker = new google.maps.Marker({
          position: latlng_saved,
          map: gmap,
          icon: themarker_image,
          animation: google.maps.Animation.DROP,
          title: 'Postition'
        });
        setTimeout(() => {
          gmap.setZoom(15);
          gmap.panTo(themarker.getPosition());
          // showAddress();
          document.getElementById('input-radius').value = service_radius === 0 ? "":service_radius.toString();
        }, 500);
      }
    },100);
  }


  $("#modal_google_gps").on("shown.bs.modal", function () {
    google.maps.event.trigger(gmap, "resize");
  });

  function btn_modal_map(){
    var position = {};
    // position.lat = latlng.lat();
    // position.lng = latlng.lng();
    // position.lat = latlng.lng();    // switch bewteen LAT to LNG for MongoDB
    // position.lng = latlng.lat();    // switch bewteen LAT to LNG for MongoDB
    // position.address = $('#address').val();
    position.lat = latlng_saved.lng;    // switch bewteen LAT to LNG for MongoDB
    position.lng = latlng_saved.lat;    // switch bewteen LAT to LNG for MongoDB
    position.service_radius = parseInt($('#input-radius').val());
    console.log(position);

    if(tempcbfnc_maps){
      tempcbfnc_maps(position);
    }else{

    }
    $('#modal_google_gps').modal('hide');
  }

</script>
