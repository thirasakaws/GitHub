<div id='gmap_ordergps'>
</div>
<div class="container-fluid main_data">
    <div id="top_shopping_cart" class="row-fluid navbar w-100 shadow nav-color-shop box-head-title-foodmall topmenu-navbar">

        <div class="col-1 pl-0 text-left">
            <button class='btn border border-0 text-secondary' onclick="go2View('cart-manage-main');">
                 <i class="fas fa-chevron-left"></i>
             </button>
        </div>
        <div class="col text-center">
            <div class="header-foodmall font-color-foodmall-gray-medium mt-1"> สรุปรายการสั่งซื้อ </div>
        </div>
        <div class="col-1 text-right">
<!--            <div class="d-block mr-4" onclick="go2View('cart')">
                <img src="/image/icons8-shopping-cart-80.png" class="float-right" alt="" style="width: 52%; max-width:45px;"/>
            </div>
            <div class="items-add-to-cart badge badge-pill badge-danger">##CART-totalitem##</div>-->
        </div>
    </div> <!-- topmenu -->




  <div class="text-secondary d-flex justify-content-between ">
    <h6 class="font-color-foodmall-gray-medium">ข้อมูลการจัดส่ง</h6>

    <span class="btn btn-sm btn-outline-danger" onclick="resetorder();"> <i class="fas fa-trash-alt text-danger" ></i> ยกเลิกรายการ</span>
  </div>


  <div class="">
    <!--<small>ส่งไปยัง</small>-->
    <div class="row mt-3">
        <div class="col-6">
            <div class="form-group">
                <label class="font-color-foodmall-gray-light2 lable-left-35 " > ชื่อ <span class="text-danger">*</span></label>
                <input class="input_data_bn edit_data CUSTOMER_firstname ORDER_firstname w-90 " placeholder="" data-field="firstname">
            </div> <!--// -->

        </div>
        <div class="col-6">
           <div class="form-group">
                <label class="font-color-foodmall-gray-light2 lable-left-35 " > นามสกุล  <span class="text-danger">*</span></label>
                <input class="input_data_bn edit_data CUSTOMER_lastname ORDER_lastname w-90 " placeholder="" data-field="lastname">
            </div> <!--// -->
        </div>
    </div>
    <div class="row ">
        <div class="col-12">
            <div class="form-group row">
                <label class="col-sm-4 lable-left-35 font-color-foodmall-gray-light2" >  เบอร์ติดต่อ <span class="text-danger">*</span> </label>
                <div class="col">
                    <input class="input_data_bn edit_data ORDER_contact w-90 " id="contact" type="tel" maxlength="10" data-field="contact"  onkeypress="return isNumberKey(event)"> <br>
                    <small class="warn_phoneinput text-danger" style="display:none;">**รูปแบบไม่ถูกต้อง</small>
                </div>
            </div> <!--// -->
        </div>

        <div class="col-12">
            <div class="form-group row">
                <label class="col-sm-4 lable-left-35 font-color-foodmall-gray-light2" >   วิธีการจ่ายเงิน <span class="text-danger">*</span> </label>
                <div class="col">
                    <select id="paymenttype" class="input_data_bn  edit_data ORDER_paymenttype" data-field="paymenttype" placeholder="วิธีการจ่ายเงิน">
                      <option value="" disabled selected>โปรดระบุ</option>
                      <option value="1" disabled>เก็บเงินปลายทาง</option>
                      <option value="2" disabled>QR payment By Quickpay</option>
                      <option value="3" disabled>ลูกค้ารับเองที่ร้าน</option>
                  </select>
                </div>
            </div> <!--// -->
        </div>

    </div> <!--// row -->
  </div>


<!--  <hr>-->

  <div class="form-group mt-3 border-bottom border-light mt-3">
    <div class="row">
      <div class="col-6">
          <label class="font-color-foodmall-gray-light2 " style="width:auto;"> ที่อยู่ปลายทาง</label>
      </div>
      <div class="col-6 text-right">
          <div class="ml-auto">
           <button type="button" name="button" class="btn btn-sm btn-outline-submit-foodmall rounded-pill" onclick='find_location_order();'>
               <i class="fas fa-plus"></i> เพิ่มที่อยู่
           </button>
          </div>
       </div>
    </div> <!--// -->


     <div class="row mt-2">
       <div class="col-12" onclick='showlist_address();'>
          <input disabled class="form-control border-0 bg-light" id="addres_area" placeholder="คลิกที่นี่เพื่อดูรายการที่อยู่">
          <div class="row">
            <div class="col-12 text-center">
              <div class="btn btn-block">
                  <strong class="text-secondary"> <span>เลือกที่อยู่</span> <i class="fas fa-angle-down"></i></strong>
              </div>
            </div>
          </div>
       </div>
     </div>
     <div class="text-left card" id="showlist_address" style="display:none;">
       <div class="card-body">
         <div class="" id="address_list">
           <div class="custom-control custom-radio row_tablecontent p-2" style="display:none;" >
             <div class="row">
               <div class="col-10">
                 <input type="radio" class="custom-control-input radio_id " id="" name="groupOfDefaultRadios" onchange="updateorder_add(this);">
                 <label class="custom-control-label radio_for" for="">
                   <span class="add_name"></span> <span class="add_detail"></span> <br>
                    <small> <span class="add_address"></span></small>

                 </label>
               </div>
               <div class="col-2">
                    <span class="text-danger btn btn-light" onclick="changethis_add(this,'disabled');"><i class="fas fa-trash-alt"></i></span>
               </div>

             </div>
           </div>
         </div>
       </div>
     </div> <!--// -->

 </div>




  <div class="mt-2 mb-2 bg-space-gray"></div>

  <div class="mt-1 mb-5">
      <h6 class="font-color-foodmall">สรุปคำสั่งซื้อ</h6>
    <div class="" id="listmenuorder">
      <div class="row row_tablecontent" style="display:none">
        <div class="col-2 text-left">
            <span class="menu_qty">0</span>
            <span class="font-color-foodmall-gray-light2">x</span>
        </div>  <!--// จำนวน -->

        <div class="col-7">
            <span class="menu_name">ชื่อเมนู</span> <span class="menu_pricedes"></span>

            <small class="menu_notedate" style="display:none;">(<span class="menu_note"></span>)</small>
            <small class="menuoptionshow" ></small>
        </div> <!--// ชื่อเมนู -->

        <div class="col-3 text-right">
           ฿ <span class="menu_menuprice">0.00 </span>
        </div> <!--// ราคา -->
      </div>

    </div>
    <hr>


    <div class="align-items-center">
      <div class="row">
          <div class="col-6">
              ค่าอาหาร
          </div>
          <div class="col-6 text-right">
              ฿ <span class="total_price">0 </span>
          </div>
      </div>

      <div class="row">
          <div class="col-6">
              ค่าจัดส่ง <span class="total_distance font-color-foodmall">0 </span> กม.
          </div>
          <div class="col-6 text-right">
               ฿ <span class="total_shippingcost">0 </span>
          </div>
      </div>
      <div class="row" id='discount-shippingcost' style="display:none">
          <div class="col-6">
              ส่วนลดค่าจัดส่ง
          </div>
          <div class="col-6 text-right">
               ฿ -<span class="total_shippingdiscount">0 </span>
          </div>
      </div>

      <hr>
      <div class="row">
          <div class="col-12 text-center " >
              <span class= "text-danger small" id="order_alert"> </span>
          </div>
      </div>
      <div class="row ">
          <div class="col-6">
              รวมทั้งหมด
          </div>
          <div class="col-6 text-right ">
              ฿ <span class="grandtotal">0 </span>
          </div>
      </div>
      <hr>
    </div>

  </div>


  <div class="container-fluid fixed-bottom bg-white">
        <div class="row p-1">

              <button type="button" id="goconfirmorder" name="button" class="btn btn-lg btn-submit-foodmall btn-block" onclick="checkout_payment();" >
                  ยืนยันรายการ และชำระเงิน
<!--                   <div class="float-left">ยืนยันรายการ และชำระเงิน</div>
                   <div class="float-right"> ฿ <span class='grandtotal'></span></div>-->
               </button>

        </div> <!-- // ยอดรวม และ ปุ่ม -->
      </div> <!-- // container-fluid  -->


<!--  <div class="fixed-bottom m-1 bg-white">
    <button type="button" name="button" class="btn btn-lg btn-block btn-submit-foodmall" onclick="checkout_payment();"> ยืนยันรายการ และชำระเงิน </button>

  </div>-->

</div>
<script>
  var showlistadd_temp = $('#address_list').html();
  var template_ordermenulist = $('#listmenuorder').html();
  refresh_managecart1();

  //for input tag
  $('.edit_data').Fusefield( (obj,cb,data)=>{
    // console.log("data",data);
    if (data.contact) {
          if (data.contact.toString().length!= 10) {
                alert('กรุณากรอกเบอร์โทรให้ถูกต้อง');
                $('#contact').focus();
                cb(false);
               return false;
          }
    }
    $.postJSON('/engine/order/update', data, function (res) {
        if (!res.result) {
            alert(res.detail);
            cb(false);
        }else {
            res.detail ? working.order = res.detail : false;
          cb(true);
        }
    })
  },(obj)=>{
    return true;
  });


    function refresh_managecart1(){
      if (working.order) {
        console.log("ORDER",working.order);

      }
            // getUsercustomer();
            getcustomeraddress();
            setTimeout(()=>{
              showmwnuorderlist(working.order.items);
              setdatabyclass($('.main_data'), 'ORDER', working.order);

            },500);

    }




    function isNumberKey(e){
      if(e){
      if($('#contact').val().toString().length>=10){
        return false;
      }
      // if(!event.keyCode){
      //   e.preventDefault();
      // }
    var charCode = (e.which) ? e.which : event.keyCode
// alert(charCode)
    // if (!charCode) {
    //
    // }

    if (charCode > 31 && (charCode < 48 || charCode > 57))
        return false;
    return true;
  }else{
    alert('not have event')
  }
}

    // $('#contact').on('keyup keydown', function(e){
    //   // alert(e.keyCode);
    //     if ($(this).val().length >= 10
    //         // && e.keyCode !== 46
    //         && e.keyCode !== 8
    //        ) {
    //        e.preventDefault();
    //        // $('.warn_phoneinput').show();
    //        // $(this).val(10);
    //     }else {
    //       // $('.warn_phoneinput').hide();
    //     }
    // });

    const input_contact = document.getElementById('contact');
    input_contact.oninput = inputContactHandler;

    function inputContactHandler(e) {
      // alert("inputContactHandler: " + e.target.value);
      var last_val = e.target.value.substr(e.target.value.length - 1);
      // alert(e.target.value.substr(e.target.value.length - 1));
      if (last_val < "0" || last_val > "9" || last_val == '.') {
        e.target.value = e.target.value.slice(0, e.target.value.length - 1);
      }
      // service_radius = parseFloat(e.target.value);
      // // document.getElementById('input-radius').value = service_radius.toString();
      // circle_area.setRadius(service_radius * 1000.0);
    }

    function getcustomeraddress(){
       $('#address_list').html(showlistadd_temp);
      $.postJSON('/api/liff/get/address', {LINE_USER: LINE_USER}, function (res) {
        if(res.result){
          obj = res.detail;
          if(obj.length >0){
              working.address = res.detail;
              var found;
              for(var x=0;x<obj.length;x++){
                     var TR = tablerow($("#address_list"), 'add', obj[x], showlistadd_temp, false);
                     if (working.order.addressid) {
                       if(obj[x]._id == working.order.addressid){
                         found = true;
                         working.order.addresslocation = obj[x].location;
                          TR.find('.radio_id').prop('checked', true);
                          $('#addres_area').val(obj[x].name);
                          if (obj[x].detail) {
                                  $('#addres_area').val(obj[x].name+' '+obj[x].detail);
                          }
                          $('#addres_area').attr('data-id', working.order.addressid)
                       }
                     }
                     TR.find('.radio_id').attr('id','add'+obj[x]._id);
                     TR.find('.radio_for').attr('for','add'+obj[x]._id);
                     TR.show();
                }
                if(!found){
                  working.order.addressid = working.address[0]._id;
                  working.order.addressname = working.address[0].address;
                    if (working.address[0].detail) {
                      working.order.addressdetail = working.address[0].detail;
                    }
                  working.order.addresslocation = working.address[0].location;

                  update_order();
                }
              }else {
                $('#addres_area').val('');
                $('#addres_area').attr('placeholder',"คุณยังไม่มีข้อมูลที่อยู่ กรุณาเพิ่มที่อยู่");
              }

        }else{
          $('#addres_area').attr('placeholder',"คุณยังไม่มีข้อมูลที่อยู่ กรุณาเพิ่มที่อยู");
        }
      });
    };

var array_shopid = [];

    function showmwnuorderlist(obj){
      array_shopid = [];
      $('#listmenuorder').html(template_ordermenulist);

        for(var x=0;x<obj.length;x++){
          array_shopid.push(obj[x].shopid);
          obj[x].menuprice = Number(obj[x].price.price) * Number(obj[x].qty);
        //  totalprice += obj[x].menuprice;
          obj[x].pricedes = obj[x].price.detail;
               var TR = tablerow($("#listmenuorder"), 'menu', obj[x], template_ordermenulist, false);
               if(obj[x].menuprice>0){
                  TR.find('.menu_menuprice').html(addCommas(obj[x].menuprice));
               }else {
                 TR.find('.menu_menuprice').html('0.00')
               }
               if (obj[x].note) {
                  TR.find('.menu_notedate').show();
               }
               if(Array.isArray(obj[x].option)){
                  var html_option='';
                  obj[x].option.map((ech)=>{
                      html_option+=`<span  class='badge badge-success'>${ech}</span> `;
                  });

                  TR.find('.menuoptionshow').html(html_option)
               }

               TR.show();

               /// +=delivery
        }
          if(array_shopid.length > 0){
            getorder_shop(array_shopid);
          }

        update_ship_cost();

    }

    function getorder_shop(array){

      $.postJSON('/api/liff/check/order/shop', {_id : array}, function (res) {
        // console.log("LOCATE",res);
        if(res.result){
          // var optiondata = '';
          // optiondata += '<option value="" disabled selected>โปรดระบุ</option>';
             working.ordershop = res.detail;
             // var paymentoption = ['','Cash On Delivery','QR payment By Quickpay'];
            paymenttype = [];
             var arr = working.ordershop;
             if(arr.length>0){
                   for(var x=0;x<arr.length;x++){
                        for(var y=0;y<arr[x].paymenttype.length;y++){
                            if(paymenttype.indexOf(arr[x].paymenttype[y]) == -1){
                                  // paymenttype.push(arr[x].paymenttype[y]);
                                  // console.log('****'+$('#paymenttype option[value='+arr[x].paymenttype[y]+']').val());
                                 $('#paymenttype option[value='+arr[x].paymenttype[y]+']').prop('disabled',false);
                                    // optiondata += '<option value="' +arr[x].paymenttype[y] + '">' + paymentoption[arr[x].paymenttype[y]] + '</option>';
                            }
                        }
                   }
                 }
                 // $('#paymenttype').html(optiondata);
        }else{
          // alert(res.detail);
        }
      });
    };

    $('#gmap_ordergps').load('/SHOPS/modal_gps_full.html');
      function find_location_order() {
        // alert('show')
        var pos;
        if (working.order.location && Array.isArray(working.order.location.coordinates)) {
            // Already input Location
            pos = {lat: working.order.location.coordinates[0], lng: working.order.location.coordinates[1],user_type:"customer"};
            // console.log('pos',pos);
        } else {
                      pos = {}
        }
        call_modal_maps(pos, function (data) {
            console.log('DataBack:', data);
            // addcusaddress(data)
            working.new_address = {}
            working.new_address.address = data.address;
            working.new_address.location = { type: "Point", coordinates: [data.lat, data.lng] };

            if (working.new_address.address) {
              setTimeout(()=>{
                  go2View('manage_address-main');
              },500)

            }

        });
      };
      function addcusaddress(loc){
        var data = {
          LINE_USER : LINE_USER,
          address : loc.address
          };
        data.location = { type: "Point", coordinates: [loc.lat, loc.lng] };
        // console.log('ORDER GPS',data);

        $.postJSON('/api/liff/update/address', data, function (res) {
          // console.log("LOCATE",res);
          if(res.result){
              // $('#writelocation_cus').show('slow').hide('slow');
              getcustomeraddress();
          }else{
            alert(res.detail);
          }
        });
      };

    function updateorder_add(obj) {
      if ($(obj).is(':checked')) {
        var dataid = $(obj).parents('.row_tablecontent').attr('data-id');
        working.order.addressid = dataid;
        for(var x=0;x<working.address.length;x++){
          if (working.address[x]._id==dataid) {
              working.order.addressname = working.address[x].address;
              working.order.addressdetail = working.address[x].detail;
              working.order.addresslocation = working.address[x].location;
              working.order.addressid = working.address[x]._id;
          }
        }
        update_order();
        }
        // console.log('order -- ',working.order);

    }
    function changethis_add(obj,action){
        var dataid = $(obj).parents('.row_tablecontent').attr('data-id');
        if(confirm('ยืนยันที่จะลบที่อยู่นี้ ?')){
          var data = {
            LINE_USER : LINE_USER,
            _id : dataid,
            active : false
            };

          $.postJSON('/api/liff/update/address', data, function (res) {
            // console.log("LOCATE",res);
            if(res.result){
                getcustomeraddress();
            }else{
              alert(res.detail);
            }
          });
        }

    }

    function update_order(){
      var data = {
                  LINE_USER: LINE_USER,
                  addressid:working.order.addressid,
                  addressname : working.order.addressname,
                  addresslocation :  working.order.addresslocation,
                  addressdetail : working.order.addressdetail,
                  // firstname : $('.ORDER_firstname').val(),
                  // lastname : $('.ORDER_lastname').val(),
                  // contact : $('.ORDER_contact').val()
                };
                // console.log("data",data);
      $.postJSON('/engine/order/update',data,(res)=>{
          if(res.result){
            // console.log('update',res);
              if(res.detail) working.order = res.detail;
              $('.warn-save').show('slow').hide('slow');
              getcustomeraddress();
              $('#showlist_address').hide();
              checkorder_status();
              update_ship_cost();
              showlist_address_temp=false;
            }else{

            }
         });
    }
    function checkorder_status(){
      var order=working.order;
      if(!order.branch_found){
        if(order.systemcomment){
            $('#order_alert').html(order.systemcomment).show('slow');
        }else{
            $('#order_alert').html('*** ที่อยู่จัดส่งไม่ถูกต้อง').show('slow');
        }
        $('#goconfirmorder').prop('disabled',true);
        $('.grandtotal').html('-');
        $('.total_distance').html('-');
        $('.total_shippingcost').html('-');
        $('#discount-shippingcost').hide();
        return false;
      }else{

        $('#order_alert').html('').hide();
        $('#goconfirmorder').prop('disabled',false);
        return true;
      }
    }
    function update_ship_cost(){

      var order=working.order;
      checkorder_status();

      $('.total_price').html(order.totalcost ? addCommas(order.totalcost) : '0.00') ;
      $('#discount-shippingcost').hide();
      if(order.logistic){
          $('.total_distance').html( order.logistic.distanceShopToCustomerInKM ?  addCommas(order.logistic.distanceShopToCustomerInKM) : '0.00');
          $('.total_shippingcost').html(order.logistic.deliveryTotalAmount ? addCommas(order.logistic.deliveryTotalAmount) : '0.00');

          if(Number(order.logistic.Discount) > 0){
            var beforediscount = addCommas(order.logistic.deliveryTotalAmount + order.logistic.Discount);
            $('#discount-shippingcost').show();
            $('.total_shippingdiscount').html(addCommas(order.logistic.Discount));
            $('.total_shippingcost').html(addCommas(beforediscount));
          }else{
            $('#discount-shippingcost').hide();
          }
      }
      var grandtotal = 0;
        if(working.order.grandtotal){
          grandtotal = Number( working.order.grandtotal);
        }else{
          grandtotal = Number(order.totalcost)
          if(order.logistic && order.logistic.deliveryTotalAmount){
            grandtotal +=order.logistic.deliveryTotalAmount;
          }
        }

       $('.grandtotal').html(addCommas(grandtotal) );//addCommas(working.order.grandtotal));

    }
    function checkout_payment(){
      console.log('order',working.order.firstname);

      if(working.order.firstname || working.order.firstname !==''){
        if(working.order.lastname || working.order.lastname !==''){


        }else{
          alert('กรุณาระบุนามสกุลผู้รับ')
          return false;
        }

      }else{
        alert('กรุณาระบุชื่อผู้รับ')
        return false;
      }

      if(!working.order.contact || working.order.contact.toString().length != 10){
        alert('กรุณาระบุเบอร์ติดต่อ');
        $('#contact').focus();
        return false;
      }
      if(Number(working.order.paymenttype) > 0){

      }else{
        alert('กรุณาระบุวิธีการชำระเงิน')
        return false;
      }
      if(Number(working.order.addressid) >0){


      }else{
        alert('กรุณาระบุที่อยู่ปลายทาง')
        return false;
      }
      if(!working.order.branch_found) return false;
      if(working.order && working.order.items && working.order.items.length >0 && working.order._id){
          liff.sendMessages([{
                   'type': 'text',
                   'text': "OrderConfirm: #"+working.order._id
               }]).then(function() {
                   liff.closeWindow();
               }).catch(function(error) {
                  console.log("Send Error");
                   window.alert('Error: คุณไม่ได้อนุญาติให้ App เราส่งข้อความ\r\n กรุณาอนุญาติเพื่อให้ทำรายการได้');
               });

      }else{
          alert("รายการสั่งซื้อของคุณยังไม่พร้อมสำหรับชำระเงิน");
      }
    };

    var showlist_address_temp=false;
    function showlist_address(){
      $('.showadd_address').hide();

      if(showlist_address_temp){
        $('#showlist_address').hide();
      }else{
          $('#showlist_address').show();
      }
      showlist_address_temp = !showlist_address_temp;
    }

</script>
