
<div class="container-fluid">

<div class="shadow">
  <div class="box-head-title-shop text-left line-bottom-color-shop fixed-top shadow" style="background-color: #ffff !important;" >
        <h4 class="header-shop"> รายการออร์เดอร์ของฉัน</h4>
  </div>
</div>


  <!-- <div class="shadow"  >
      <div class="row box-head-title-foodmall fixed-top shadow" style="background-color: #F6F6F6 !important;">
          <div class="col-3 p-0 pl-1 text-left">
          </div>
          <div class="col-6 p-0 text-center">
              <div class="header-foodmall font-color-foodmall-gray-medium mt-1"> รายการออร์เดอร์ของฉัน</div>
          </div>
          <div class="col-3 text-right">
          </div>
      </div>

  </div>  -->



  <div id="order_history" class="mt-5">
      Please Wait..
  </div>



  <div id="order_template" style="display:none;">

      <div class="card row_tablecontent mb-3" >
        <div class="card-body">
          <div class=" align-items-center row">
            <div class="col-6">
                  <small>ร้าน <span class="badge badge-pill badge-secondary"> ##ORDER-shopname## สาขา ##ORDER-shopbranch## </span></small>
            </div>
            <div class="col-6 text-right">
                  <small>เวลา <span class="badge badge-pill badge-success"> ##ORDER-time## </span></small>
            </div>

          </div>
          <div class="text-center">
              <strong>ORDER# ##ORDER-id## <span>สถานะ</span> <span class="text-secondary"> ##ORDER-statusshow## </span> </strong>
          </div>
          <div class="row">
            <div class="col-6 text-center">
              <small class="btn btn-sm btn-success rounded-pill mt-2" onclick="previeworder(##ORDER-id##)">
                  <span class=""><i class="far fa-eye"></i> ดูข้อมูล </span>
                </small>
            </div>
            <div class="col-6 text-right">
                  <small> <span> ##ORDER-totalitems## </span> รายการ</small> <br>
                  <small> ราคารวม <span>##ORDER-grandtotal##</span> บาท</small>
            </div>
          </div>
          <div class="text-right">
              <span class="badge badge-secondary">สั่งรายการอีกครั้ง</span>
          </div>

        </div>
       </div>

    </div>




  <div id="order_template_menu" style="display:none;">
    <div class=" p-1 mt-1">
      <small class="row border-bottom">
          <div class="col-8">
              ##MENU-qty## x <span class="font-color-shop">##MENU-name## ##MENU-menuid##</span>  <br>
              <small>##MENU-pricedetail##</small> <span class="font-color-shop">##MENU-note##</span>
          </div>
          <div class="col-4 text-right">
              <span class="font-color-shop">฿ ##MENU-priceshow##</span>
          </div>
      </small>

    </div>
  </div>
</div>



<div class="modal fade" id="modal_order_preview"  tabindex="-1" role="dialog"  aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">

        <div class="modal-body" >
          <div class="">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
            <h5 class="modal-title">รายการสั่งอาหาร</h5>
          </div>
          <div class="">
              ##VIEW-menudetail##
          </div>
          <div class="text-right">
              <span>จำนวนรายการ  ##VIEW-totalitems## ชิ้น</span><br>
              <span>ระยะทาง ##VIEW-totaldistance## กม.</span><br>
              <span>ค่าจัดส่ง ##VIEW-deliveryTotalAmount## บาท</span><br>
              <strong>ราคารวมทั้งหมด ##VIEW-grandtotal## บาท</strong><br>

          </div>

        </div>

    </div>
  </div>
</div>
<script>
    all_page = ["order_seller_latest1"];
    var working = {};
    register_all_page();  // Register SubPAGE
  var template_main= $("#order_template").html();
  var order_template_menu = $('#order_template_menu').html();

  var STATUSSHOW =[];
  STATUSSHOW[1] = 'มาใหม่';
  STATUSSHOW[5] = 'รายการใหม่รอลูกค้ายืนยัน';
  STATUSSHOW[6] = 'ยกเลิก';
  STATUSSHOW[7] = 'ลูกค้ารอร้านยืนยันรายการ';
  STATUSSHOW[10] = 'รอการชำระเงินจากลูกค้า';
  STATUSSHOW[11]='ลูกค้าชำระเงินแล้ว';
  STATUSSHOW[12]='ลูกค้าจะชำระเงินแบบ COD';
  STATUSSHOW[15]='ร้านกำลังดำเนินการ';
  STATUSSHOW[16]='ร้านดำเนินการเสร็จแล้ว';
  STATUSSHOW[17]='Rider รับสินค้าแล้ว';
  STATUSSHOW[26]='ลูกค้ายกเลิก หลังรอ Confirm จากร้าน';

function runApp(){

  $.postJSON('/engine/history/customerorder',{LINE_USER: LINE_USER},(res)=>{
      if(res.result){
        var history = res.detail;
        working.history = history;
        if(history.length ==0){
            $("#order_history").html("ไม่พบรายการสั่งซื้อ");
          return;
        }
        if (history) {
           history.map((obj)=>{   // PREPARE ORDER DATA
              // console.log('history',obj);
              if(obj.logistic && obj.logistic.distanceShopToCustomerInKM){
                obj.totaldistance = obj.logistic.distanceShopToCustomerInKM;
                obj.deliveryTotalAmount = obj.logistic.deliveryTotalAmount;
              }else{
                obj.totaldistance =0;
              }
             if(!obj.note) obj.note='';
                  obj.statusshow = STATUSSHOW[obj.status];
                  obj.items.map((item)=>{   // setting Some Default
                      item.priceshow = item.price.price;
                      item.pricedetail = item.price.detail;
                  });
                obj.time = moment(obj.createdate,'X').format('H:m:s D/M/Y');
                obj.totalitems = obj.items.length;
                // obj.menudetail  = hash_replace(order_template_menu,'MENU',obj.items);
           });

           var html1  = hash_replace(template_main,'ORDER',history)
           $("#order_history").html(html1);
          }else {
            return 'ไม่พบเมนู'
          }
          // go2View('order_seller_latest1');
        // $('#shopingcart').html(JSON.stringify(res.detail));
      }else{
        //$('#warn-order').show();
        alert(res.detail)
        // alert(res.detail);
      }
  });
      // $('#shopi0ngcart').html(JSON.stringify(res.detail));
};



var template_modal_order_preview = $('#modal_order_preview').html();
var ordercustomerlocation = {};
function previeworder(order_id){
  console.log('id',order_id);
  var obj_cust;
    working.history.map((obj)=>{  // PREPARE Items Data
      // console.log('view',obj);
          if(obj.logistic && obj.logistic.distanceShopToCustomerInKM){
            obj.totaldistance = obj.logistic.distanceShopToCustomerInKM;
          }else{
            obj.totaldistance =0;
          }
          obj.items.map((item)=>{   // setting Some Default
              item.priceshow = item.price.price;
              item.pricedetail = item.price.detail;
          });
          obj.time = moment(obj.createdate,'X').format('H:m:s D/M/Y');
          obj.totalitems = obj.items.length;
          obj.menudetail  = hash_replace(order_template_menu,'MENU',obj.items);
      if(obj._id == order_id) obj_cust = obj;
    });

    if(obj_cust){
      console.log('view',obj_cust);
        $('#modal_order_preview').html(hash_replace(template_modal_order_preview,'VIEW',obj_cust));
        $('#modal_order_preview').modal('show');
      }
};

initializeLiff('orderlist');

//  $('#body_mainbody').load('/LIFF/preload.html');
</script>
